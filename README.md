# BAZK

## What is BAZK?

BAZK is a zkSNARK library for Phala Network. It is based on [gramine]. It is designed to be used in the following scenarios:

- **Secure Computation**: BAZK can be used to perform secure computation on sensitive data, ensuring that the data and computation results remain confidential and have not been tampered with.

## What is a Pod?

A Pod is a secure enclave that runs a program within an Intel SGX (Software Guard Extensions) environment and is attested by the Phala Phat Contract. It provides a trusted execution environment for sensitive computations, ensuring that data and code remain confidential.

### Typical Pod Operation

- **Key Generation**: The Pod generates a public-private key pair. The private key remains securely stored within the SGX enclave.

- **Remote Attestation**: The Pod undergoes SGX remote attestation, a process that verifies the integrity of the enclave and ensures it is running on a genuine SGX-enabled platform.

- **Key Validation**: The validator Phat Contract validates the Pod's identity and attestation results. Upon successful validation, the contract signs the Pod's public key, endorsing its authenticity.

- **Secure Computation and Signing**: The Pod executes sensitive computations within the SGX enclave, leveraging the enclave's secure environment to protect data confidentiality and integrity. The Pod can then use its private key to sign the computation results, providing a verifiable proof of execution.

- **Result Verification and Signature Validation**: The user receives the computation results and the corresponding signature generated by the Pod. Than it can verify the results with the following steps:
  - The user obtains the Validator contract's public key from the contract itself.
  - The user verifies the Pod's public key against the Validator contract's public key. This ensures that the Pod's public key has been endorsed by the Validator contract and is associated with a legitimate Pod.
  - The user verifies the Pod's signature on the computation results using the Pod's public key. This confirms that the results were indeed generated by the Pod and have not been tampered with.
    By performing both of these verification steps, the user can establish confidence in the authenticity and integrity of the computation results provided by the Pod.

## What's in this repo?

There are four subdirectories in this repo:

- `gramine-image/`: Dockerfile for the gramine build tools that is used to build measured pod app.
- `pod-validator/`: The source code of the validator contract.
- `ra-report/`: The js source code of the npm package used to generate attestation report and communicate with the validator contract.
- `nodejs-app-template/`: A template for pod app with attestation example.

## Getting Started

### Prerequirements

- [Docker](https://docs.docker.com/get-docker/) installed and the docker daemon is running.
- Current user is in the `docker` group.
- [Node.js](https://nodejs.org/en/download/) installed. (Tested version : `v16.17.1`)
- Intel IAS API key and SPID. (You can get it from [here](https://api.portal.trustedservices.intel.com/EPID-attestation))

### Build and deploy the validator contract

First you can build the validator contract by running the following command in the root directory of this repo:

```bash
cd pod-validator/
patron build

# When build successfully, you would get an HTTP URL like this:
# https://patron.works/codeHash/7298c937d5a638271892eaa35fda08ee931bcf5b197ff3a8a602e978243443f4
```

That requires you to have [patron](https://patron.works/getting-started) installed. If you don't want to install it and the Rust toolchain, you can use the compiled contract from [here](https://patron.works/codeHash/7298c937d5a638271892eaa35fda08ee931bcf5b197ff3a8a602e978243443f4).

Goto the contract link on patron, click the `Deploy with Phala` button and follow the instructions to deploy the contract.
If everything goes well, you would get a contract address, that would be used in the next step, and a web page to operation with the contract.

### Build rust library for KZG and Groth16

```bash
cd phase2-bn254/powersoftau
cargo build --release --bin new_constrained
cargo build --release --bin compute_constrained
cargo build --release --bin verify_transform_constrained
cargo build --release --bin beacon_constrained
cargo build --release --bin prepare_phase2

mkdir -p ../../gramine/bazk-build/bin/
cp target/release/new_constrained ../../gramine/bazk-build/bin
cp target/release/compute_constrained ../../gramine/bazk-build/bin
cp target/release/verify_transform_constrained ../../gramine/bazk-build/bin
cp target/release/beacon_constrained ../../gramine/bazk-build/bin
cp target/release/prepare_phase2 ../../gramine/bazk-build/bin

cd ../phase2

cargo build --release --bin new
cargo build --release --bin contribute
cargo build --release --bin verify_contribution

cp target/release/new ../../gramine/bazk-build/bin
cp target/release/contribute ../../gramine/bazk-build/bin
cp target/release/verify_contribution ../../gramine/bazk-build/bin
```

### Build the pod app

You can clone this repo and develop your pod app based on the template in `nodejs-app-template/` directory.

Edit the ` index.ts` to replace the value of `VALIDATOR_CONTRACT_ADDRESS` with the address you got from the previous step.
And maybe replace the rpc endpoint if you deployed it on a different testnet.

To build the template app, run the following command in the root directory of this repo:

```bash
cd gramine/
yarn && yarn build
export IAS_SPID=YOUR_IAS_SPID
./build.sh
```

You would get a measurement result in the log like this:

```
    0000000000010000-00000001ff463000 [REG:RWX] (free)
Measurement:
    fc7f4aab5436670d2f4b26c71441cdc420a0d7537b68d4d06c1d6b907cf35d57
```

### Add the measurement result to the validator contract

Goto the contract web page and click the `allow` button, paste the measurement result(don't forget to add the prefix `0x`) you got from the previous step click the [Run] button.
You will see a line of log in the log panel like this:

```
[#638695][2023-10-20T04:16:42.157Z] Added: 0xfc7f4aab5436670d2f4b26c71441cdc420a0d7537b68d4d06c1d6b907cf35d57
```

### Run the pod app

To run the pod app, you need a machine with at least Linux kernel v5.13 and SGX enabled.

```bash
cd phase1-build/
sudo docker run --rm --device /dev/sgx_enclave --device /dev/sgx_provision -v`pwd`/dist:/app -it gramineproject/gramine
cd /app
export IAS_API_KEY=YOUR_IAS_API_KEY_GOT_FROM_INTEL

# Phase 1 (KZG)

./gramine-sgx phase1 app/index.js ./bin/new_constrained challenge1 10 256

./gramine-sgx phase1 app/index.js ./bin/compute_constrained challenge1 response1 10 256
./gramine-sgx phase1 app/index.js ./bin/verify_transform_constrained challenge1 response1 challenge2 10 256

./gramine-sgx phase1 app/index.js ./bin/compute_constrained challenge2 response2 10 256
./gramine-sgx phase1 app/index.js ./bin/prepare_phase2 response2 10 256

# Phase 2 (Groth16)

./gramine-sgx phase1 app/index.js ./bin/new circuit.json circom1.params ./

./gramine-sgx phase1 app/index.js ./bin/contribute circom1.params circom2.params
./gramine-sgx phase1 app/index.js ./bin/verify_contribution circuit.json circom1.params circom2.params ./