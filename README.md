# phat-pod-tools

## What is a Pod?

A Pod is a secure enclave that runs a program within an Intel SGX (Software Guard Extensions) environment and is attested by the Phala Phat Contract. It provides a trusted execution environment for sensitive computations, ensuring that data and code remain confidential.

### Typical Pod Operation

- **Key Generation**: The Pod generates a public-private key pair. The private key remains securely stored within the SGX enclave.

- **Remote Attestation**: The Pod undergoes SGX remote attestation, a process that verifies the integrity of the enclave and ensures it is running on a genuine SGX-enabled platform.

- **Key Validation**: The validator Phat Contract validates the Pod's identity and attestation results. Upon successful validation, the contract signs the Pod's public key, endorsing its authenticity.

- **Secure Computation and Signing**: The Pod executes sensitive computations within the SGX enclave, leveraging the enclave's secure environment to protect data confidentiality and integrity. The Pod can then use its private key to sign the computation results, providing a verifiable proof of execution.

- **Result Verification and Signature Validation**: The user receives the computation results and the corresponding signature generated by the Pod. Than it can verify the results with the following steps:
  - The user obtains the Validator contract's public key from the contract itself.
  - The user verifies the Pod's public key against the Validator contract's public key. This ensures that the Pod's public key has been endorsed by the Validator contract and is associated with a legitimate Pod.
  - The user verifies the Pod's signature on the computation results using the Pod's public key. This confirms that the results were indeed generated by the Pod and have not been tampered with.
  By performing both of these verification steps, the user can establish confidence in the authenticity and integrity of the computation results provided by the Pod.

## What's in this repo?

There are four subdirectories in this repo:

- `gramine-image/`: Dockerfile for the gramine build tools that is used to build measured pod app.
- `pod-validator/`: The source code of the validator contract.
- `ra-report/`: The js source code of the npm package used to generate attestation report and communicate with the validator contract.
- `nodejs-app-template/`: A template for pod app with attestation example.

## Getting Started

### Prerequirements

- [Docker](https://docs.docker.com/get-docker/) installed and the docker daemon is running.
- Current user is in the `docker` group.
- [Node.js](https://nodejs.org/en/download/) installed. (Tested version : `v16.17.1`)
- Intel IAS API key and SPID. (You can get it from [here](https://api.portal.trustedservices.intel.com/EPID-attestation))

### Build and deploy the validator contract

First you can build the validator contract by running the following command in the root directory of this repo:

```bash
cd pod-validator/
patron build

# When build successfully, you would get an HTTP URL like this:
# https://patron.works/codeHash/7298c937d5a638271892eaa35fda08ee931bcf5b197ff3a8a602e978243443f4
```

That requires you to have [patron](https://patron.works/getting-started) installed. If you don't want to install it and the Rust toolchain, you can use the compiled contract from [here](https://patron.works/codeHash/7298c937d5a638271892eaa35fda08ee931bcf5b197ff3a8a602e978243443f4).

Goto the contract link on patron, click the `Deploy with Phala` button and follow the instructions to deploy the contract.
If everything goes well, you would get a contract address, that would be used in the next step, and a web page to operation with the contract.

### Build the pod app

You can clone this repo and develop your pod app based on the template in `nodejs-app-template/` directory.

Edit the ` index.ts` to replace the value of  `VALIDATOR_CONTRACT_ADDRESS` with the address you got from the previous step.
And maybe replace the rpc endpoint if you deployed it on a different testnet.

To build the template app, run the following command in the root directory of this repo:

```bash
cd nodejs-app-template/
yarn && yarn build
IAS_SPID=YOUR_SPID_GOT_FROM_INTEL ./build.sh
```

You would get a measurement result in the log like this:

```
    0000000000010000-00000001ff463000 [REG:RWX] (free)
Measurement:
    77a4da49a4cc1b1db7fb44dab7200af92003265817ac63392f2ad91cb5fe3f1e
```

### Add the measurement result to the validator contract

Goto the contract web page and click the `allow` button, paste the measurement result(don't forget to add the prefix `0x`) you got from the previous step click the [Run] button.
You will see a line of log in the log panel like this:
```
[#638695][2023-10-20T04:16:42.157Z] Added: 0x77a4da49a4cc1b1db7fb44dab7200af92003265817ac63392f2ad91cb5fe3f1e
```

### Run the pod app

To run the pod app, you need a machine with at least Linux kernel v5.13 and SGX enabled.

```bash
cd nodejs-app-template/gramine-build/
docker run --rm --device /dev/sgx_enclave --device /dev/sgx_provision -v`pwd`/dist:/app -it gramineproject/gramine
cd /app
IAS_API_KEY=YOUR_IAS_API_KEY_GOT_FROM_INTEL ./gramine-sgx node
```

See the source code of template app for more details.

### Hack-a-chain: Deployed contract

Code hash: 0xf58bd9c25d7a1844e4be5448d29076caddbc50e95a3f5b6e3bd895576eba844f
Contract ID: 0x111020f17d7d9347a6c18e77080b5ab18834cf1cd85d8948881a0bca342c5017